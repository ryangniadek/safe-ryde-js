<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Ride Requested</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>

<body>
    <div class="w3-container w3-red">
        <h1>Thank you for requesting a ride!</h1>
        <p>You are in the Queue</p>
    </div>

    <div class="w3-container">
        <br><br>
        <a href="index.html" class="w3-btn w3-black">Return to Home</a>
        <br><br>
    </div>


    <div class="w3-container w3-red">
        <h5>Developed at VTHacks7</h5>
        <p>By Ryan Gniadek, Ben Bernstein, Bryan Wells, Ronin Jayden</p>
    </div>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-database.js"></script>




    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->

    <script>

        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyDGE64JqjT4ZzggJq5F91evLJ6LrzMHgCY",
            authDomain: "saferyde-cbc2b.firebaseapp.com",
            databaseURL: "https://saferyde-cbc2b.firebaseio.com",
            projectId: "saferyde-cbc2b",
            storageBucket: "saferyde-cbc2b.appspot.com",
            messagingSenderId: "608465267582",
            appId: "1:608465267582:web:ceee3a149ac5a648e8212f"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

    </script>

    <script>



        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) { return pair[1]; }
            }
            return (false);
        }

        var ownerName = getQueryVariable("name");
        var phoneNumber = getQueryVariable("phone");
        var numPassengers = getQueryVariable("passengers");
        var startLocation = getQueryVariable("start");
        var endLocation = getQueryVariable("end");


        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        function addNewRide() {
            firebase.database().ref("Counter/").once("value", function (snapshot) {
                firebase.database().ref("Counter/").set(snapshot.val() + 1);
                addNewRideHelper();
            })
        }
        function addNewRideHelper() {
            firebase.database().ref("Counter/").on("value", function (snapshot) {
                var count = snapshot.val();
                var rideName = "ride" + count;
                firebase.database().ref("waitingRides/").child(rideName).set({
                    name: ownerName,
                    number: phoneNumber,
                    passengeNumber: numPassengers,
                    startingPlace: startLocation,
                    endingPlace: endLocation,
                    idnumber: count,
                    isActive: false
                })
            })

        }
        addNewRide();
        firebaseTest();
        function firebaseTest() {
            var temp;
            firebase.database().ref("waitingRides/ride50/endingPlace").set("itworked");
            firebase.database().ref("waitingRides/ride50/endingPlace").once("value", function snapshot{
                temp = snapshot.val();
            })
        }
        //setRideActive();
        var indexes = [];
        var hasSetActive = false;


        async function setRideActive() {
            var i = 0;
            var tempNum
            for (i = 0; i < 100; i++) {
                firebase.database().ref("waitingRides/ride" + i + "/idnumber").once("value", function (snapshot) {

                    tempNum = snapshot.val();
                    if (tempNum != null) {
                        firebase.database().ref("waitingRides/ride" + tempNum + "/isActive").once("value", function (newSnap) {
                            console.log(newSnap.val());
                            console.log("tempnum" + tempNum);
                            if (!newSnap.val()) {
                                indexes.push(tempNum);
                                if (hasSetActive == false) {
                                    hasSetActive = true;
                                    waitTime();
                                }
                            }
                        })



                    }

                })
            }
        }

        function setActiveRide2() {
            var lowest = Infinity;
            for (var i = 0; i < indexes.length; i++) {
                if (indexes[i] < lowest) {
                    lowest = indexes[i];
                }
            }
            console.log(lowest);
            firebase.database().ref("waitingRides/ride" + lowest + "/isActive").set(true);
        }


        async function waitTime() {
            await sleep(1000);
            console.log(indexes);
            setActiveRide2();

        }




        // console.log(ownerName);
        // console.log(phoneNumber);
        // console.log(numPassengers);
        // console.log(startLocation);
        // console.log(endLocation);
    </script>

</body>


</html>